%div(id="wrapper")
  %div(id="main-form-top")
    = form_for(@dataset, :html => {"data-toggle" => "validator", :multipart => true, :role => "form", :enctype => "multipart/form-data", :class => "input-append dataset-form" }) do |f|
      .panel-group(id="description" role="tablist" aria-multiselectable="true")
        .panel.panel-default
          .panel-heading(role="tab" id="descriptionHeading")
            %h4(class="panel-title")
              %a(class="accordion-toggle" role="button" data-toggle="collapse" data-parent="#description" href="#descriptionPanel" aria-expanded="true" aria-controls="descriptionPanel")
                %span( class="metadata-label" )
                  Description | Citation Preview:
                %span( id="creator-preview" )
                  = @dataset.creator_list && @dataset.creator_list != "" ? @dataset.creator_list : "[Creator List]"
                %span( id="year-preview" )
                  = @dataset.publication_year && @dataset.publication_year != "" ? "(#{@dataset.publication_year})" : "(#{Time.now.year}):"
                %span( id="title-preview" )
                  = @dataset.title && @dataset.title != "" ? "#{@dataset.title}." : "[The Title]."
                University of Illinois at Urbana-Champaign.
                %span( id="doi-preview" )
                  = @dataset.identifier && @dataset.identifier != "" ? "http://dx.doi.org/#{@dataset.identifier}" : ""

          .panel-collapse.collapse.in(id="descriptionPanel" role="tabpanel" aria-labelledby="descriptionHeading" )
            .panel-body
              - if @dataset.errors.any?
                .error_explaination
                  = "#{pluralize(@dataset.errors.count, "error")} prohibited this dataset from being deposited."
                  %ul
                    - @dataset.errors.full_messages.each do |msg|
                      %li
                        = msg
              .row
                .col-md-6
                  .form-group.required
                    = f.label :title, "Dataset Title", :class => "control-label"
                    %br
                    = f.text_field :title, :class => "form-control dataset", :placeholder => "[The Title]"
                .col-md-6
                  .form-group.required
                    = f.label :license, "License", :class => "control-label"
                    %a(href="#" data-toggle="modal" data-target="#licenseModal" tabindex="-1")
                      %span(class="glyphicon glyphicon-question-sign")
                    = f.collection_select :license, LicenseInfo.order('code ASC'), :code, :name, {:prompt => true}, {:class => "form-control dataset"}

              %label(class="control-label required")
                Author List
              (One primary long term contact required.
              %span(id="email_required_span") Email Required for primary contact.
              )
              %br
              %input(type="hidden" name="creator_index_max" id="creator_index_max" value="#{@dataset.creators.count}" )
              = f.hidden_field :complete
              %table(id="creator_table" class="table table-striped" )
                %thead
                  %tr(class="row" )
                    %th(class="col-md-1")
                    %th(class="col-md-2")
                      .form-heading-required
                        Family Name
                    %th(class="col-md-2")
                      .form-heading-required
                        Given Name
                    %th(class="col-md-2")
                      ORCIDÂ® iD
                    %th(class="col-md-1" )
                    %th(class="col-md-2")
                      Email
                    %th(class="col-md-1" )
                      .form-heading-required
                        Contact
                    %th(class="col-md-1")

                %tbody

                - @dataset.creators.each_with_index do |creator, i|

                  = f.fields_for :creators, creator do |cf|
                    %tr(class="item row" id="creator_index_#{i}" )

                      %td(class="col-md-1")
                      -# row position handle and author position value inserted via AJAX
                      %td(class="col-md-2")
                        = cf.hidden_field :_destroy, value: false
                        = cf.hidden_field :row_position # value set via AJAX
                        = cf.hidden_field :type_of, value: Creator::PERSON
                        = cf.text_field :family_name, class: "form-control dataset creator", placeholder: "[Family Name, e.g.: Smith]", onchange: "generate_creator_preview()"
                      %td(class="col-md-2")
                        = cf.text_field :given_name, class: "form-control dataset creator", placeholder: "[Given Name, e.g.: John W., Jr. ]", onchange: "generate_creator_preview()"
                      %td(class="col-md-2")
                        = cf.text_field :identifier, class: "form-control dataset", "data-mask" => "9999-9999-9999-999*", placeholder: "[xxxx-xxxx-xxxx-xxxx]"
                        = cf.hidden_field :identifier_scheme, value: "ORCID"
                      %td(class="col-md-1" )

                        %button(type="button" class="btn btn-primary btn-sm orcid-search-btn" onclick="showOrcidSearchModal('#{i}')" )
                          %span(class="glyphicon glyphicon-search" )
                          Look Up
                      %td(class="col-md-2")
                        = cf.email_field :email, class: "form-control dataset creator-email", placeholder: "[Email, e.g.: netid@illinois.edu]", onchange: "handle_creator_email_change(this)"
                      %td(class="col-md-1" align="center" )
                        = cf.hidden_field :is_contact
                        -#%input(name="dataset[creators_attributes][#{i}][is_contact]" type="hidden" value="#{creator.is_contact?}")
                        - if creator.is_contact?
                          %input(type="radio" name="primary_contact" class="dataset contact_radio" value="#{i}" onchange="handle_contact_change()" checked="true" )
                        -else
                          %input(type="radio" name="primary_contact" class="dataset contact_radio" value="#{i}" onchange="handle_contact_change()" )
                      %td(class="col-md-1")
                        -# Add/Remove Creator buttons inserted via ajax
              %table(id="deleted_creator_table")
                %tbody

              .field
                = f.hidden_field :publisher, :value=>"University of Illinois at Urbana-Champaign"

              .form-group
                = f.label :description, "Dataset Description", :class => "control-label"
                %br
                = f.text_area :description, :rows => 3,  :class => "form-control dataset", :placeholder => "[Description of this dataset, including an overview of content, structure, and format.]"

              .form-group
                = f.label :keywords, "Keywords (Semi-colon delimited list)", :class => "control-label"
                %br
                = f.text_field :keywords, :class => "form-control dataset", :placeholder => "[Semi-colon separated list of keywords or phrases, e.g.: (institutional repositories; file formats)]"
                %span(class="help-block") Use a semi-colon (;) to separate keywords or phrases (e.g.: institutional repositories; file formats).

              = f.hidden_field :depositor_email, :class => "form-control", :id => "depositor_email", :title => "Must agree to deposit agreement to deposit data.", :required => true

              = f.hidden_field :depositor_name, :class => "form-control", :id => "depositor_name"

              - if can? :manage, @dataset
                .row
                  %span(class="col-md-4" )
                    .form-group.curator-only
                      = f.label :identifier, "DOI", :class => "control-label"
                      %br
                      = f.text_field :identifier, :class => "form-control dataset", :placeholder => "[Leave blank if requesting a DOI.]"
                  %span(class="col-md-4" )
                    .form-group.curator-only
                      = f.label :publication_year, "Publication Year", :class => "control-label"
                      %br
                      = f.number_field :publication_year, :value => "#{Time.now.year}", :class => "form-control dataset", :min => "1800", :max => "#{Time.now.year + 1}", :maxlength => 4
                  %span(class="col-md-4" )
                    .form-group.curator-only
                      =f.label :version, "Version", :class => "control-label"
                      %br
                      =f.text_field :version, :class => "form-control dataset"
              - else
                = f.hidden_field :publication_year, :value => "#{Time.now.year}"

      .panel-group(id="funder" role="tablist" aria-multiselectable="true")
        .panel.panel-default
          .panel-heading(role="tab" id="funderHeading")
            %h4(class="panel-title")
              %a( role="button" data-toggle="collapse" data-parent="#funder" href="#funderPanel" aria-expanded="false" aria-controls="funderPanel" class="accordion-toggle collapsed" )
                %span( class="metadata-label" ) Funder
          .panel-collapse.collapse(id="funderPanel" role="tabpanel" aria-labelledby="funderHeading" )
            .panel-body
              %input(type="hidden" name="funder_index_max" id="funder_index_max" value="#{@dataset.funders.count}" )
              %table(id="funder_table" class="table table-striped")
                %thead
                  %tr(class="row" )
                    %th(class="col-md-4")
                      Name
                    %th(class="col-md-4" )
                    %th(class="col-md-3")
                      Grant Number
                    %th(class="col-md-1" )
                %tbody
                  - @dataset.funders.each_with_index do |funder, i|
                    = f.fields_for :funders, funder do |ff|
                      %tr(class="item row" id="funder_index_#{i}" )
                        %td
                          =ff.hidden_field :identifier
                          =ff.hidden_field :identifier_scheme
                          =ff.collection_select :code, FunderInfo.order('display_position ASC'), :code, :name, {:prompt => true}, {:class => "form-control dataset", :onchange => "handleFunderChange(#{i})"}
                        %td
                          =ff.text_field :name, :class=> "form-control dataset funder-text", :placeholder => "[Funder Name]"

                        %td
                          =ff.text_field :grant, :class => "form-control dataset"
                        %td
              %table(id="deleted_funder_table")
                %tbody
      .panel-group(id="related" role="tablist" aria-multiselectable="true")
        .panel.panel-default
          .panel-heading(role="tab" id="relatedHeading")
            %h4(class="panel-title")
              %a(role="button" data-toggle="collapse" data-parent="#related" href="#relatedPanel" aria-expanded="false" aria-controls="relatedPanel" class="accordion-toggle collapsed" )
                %span( class="metadata-label" ) Related Materials
          .panel-collapse.collapse(id="relatedPanel" role="tabpanel" aria-labelledby="relatedHeading" )
            .panel-body
              Related Materials Form Placeholder

      .panel-group(id="funder" role="tablist" aria-multiselectable="true")
        .panel.panel-default
          .panel-heading(role="tab" id="embargoHeading")
            %h4(class="panel-title")
              %a(role="button" data-toggle="collapse" data-parent="#embargo" href="#embargoPanel" aria-expanded="false" aria-controls="embargoPanel" class="accordion-toggle collapsed" )
                %span( class="metadata-label" ) Release Date
          .panel-collapse.collapse(id="embargoPanel" role="tabpanel" aria-labelledby="embargoHeading" )
            .panel-body
              Release Date Form Placeholder

  %div(id="datafiles-form")

    - if (params[:action] != 'new')
      .panel-group(id="files" role="tablist" aria-multiselectable="true")
        .panel.panel-default
          .panel-heading(role="tab" id="filesHeading")
            %h4(class="panel-title")
              %a(class="accordion-toggle" role="button" data-toggle="collapse" data-parent="#files" href="#collapseFiles" aria-expanded="true" aria-controls="collapseFiles" )
                %span(class="metadata-label" ) Files
          .panel-collapse.collapse.in(id="collapseFiles" role="tabpanel" aria-labelledby="filesHeading" )
            .panel-body
              .container-fluid
                For files larger than 500 MB, importing from Box is recommended.  For files larger than Box supports, contact the
                %a(href="http://researchdataservice.illinois.edu/")Research Data Service
                %br
                Importing from Box happens in the background, so it is not necessary to keep your browser window open, but processing may be delayed at times of heavy system usage.
                %table(class="table table-striped" id="datafiles")
                  %tbody
                    - @dataset.datafiles.each do |datafile|
                      - if datafile.bytestream_name != ""
                        -if datafile.job_status == :complete
                          %tr
                            %td
                              .row
                                %span(class="col-md-8")
                                  = datafile.bytestream_name
                                %span(class="col-md-2")
                                  = number_to_human_size(datafile.bytestream_size)
                                %span(class="col-md-2")
                                  - if ((can? :manage, @dataset) || (can? :update, @dataset) && (!@dataset.complete?))
                                    %a(data-confirm="Are you sure?" class="btn btn-danger btn-sm" rel="nofollow" data-method="delete" href="/datafiles/#{datafile.web_id}")
                                      %span(class="glyphicon glyphicon-trash")
                        -else
                          %tr(id="job#{datafile.job.id}")
                            %td
                              .row
                                %span(class="col-md-4")
                                  = datafile.box_filename
                                %span(class="col-md-6")
                                  %span(class="metadata-label")
                                    STATUS:
                                  %span(class="metadata-value" )
                                    = datafile.job_status
                                  %span(class="metadata-label" )
                                    | PROGRESS:
                                  %span(class="metadata-value" )
                                    = number_to_human_size((datafile.job.progress_current) * 10000)
                                    of
                                    = datafile.box_filesize_display
                                  %span(class="metadata-note" )
                                    (refresh page to update)
                                %span(class="col-md-2")
                                  - if ((can? :manage, @dataset) || (can? :update, @dataset) && (!@dataset.complete?))
                                    %button(class="cancel-upload-btn btn btn-danger btn-sm" onclick="cancelUpload('#{datafile.web_id}', '#{datafile.job_id}')") Cancel

                %div(id="datafiles_upload_progress")
                - if ( (can? :manage, @dataset ) || ((can? :update, @dataset) && (!@dataset.complete?)) )
                  = form_for Datafile.new do |df|
                    = df.hidden_field :dataset_id, value: @dataset.id
                    .container.text-center
                      .row
                        .col-md-7
                          %span(class="fa fa-cloud-upload fa-2x" )
                          %span(class="metadata-label" )Drop files anywhere on this page
                          %span(class="metadata-label")or
                          &nbsp;
                          .btn.btn-success.fileinput-button
                            %span(class="fa fa-laptop fa-lg" )
                            Select from your computer
                            /# The file input field used as target for the file upload widget
                            = df.file_field :binary, name: "datafile[binary]", multiple: true
                          &nbsp
                          %span(class="metadata-label")or
                        .col-md-4
                          %div(id="box-select" data-link-type="direct" data-multiselect="true" data-client-id="r5tgofc05460skm84yjepz1ck16ptotr")
.review-deposit-agreement
  - if (params[:action] == 'new')
    %a(href="/review_deposit_agreement" target="_blank" ) Review Deposit Agreement
  - else
    %a(href="/datasets/#{@dataset.key}/review_deposit_agreement" target="_blank" ) Review Deposit Agreement

= render partial: 'orcid_search'
= render partial: 'license_help_modal'

%script(id="template-upload" type="text/x-tmpl")
  .upload
    {%=o.name%}
    .progress
      %div(class="bar progress-bar" style="width: 0%;")

- if !@dataset.depositor_email
  %script
    handleNotAgreed();
    $("#agreement").modal('show');

- if (params[:action] != 'new' && @dataset.datafiles.count < 1)
  %script
    $("#descriptionPanel").collapse('hide');
